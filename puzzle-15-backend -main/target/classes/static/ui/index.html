<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>15-Puzzle</title>
    <style>
        :root{
            --tile-size: 88px;
            --gap: 10px;
            --radius: 14px;
            --shadow: 0 8px 24px rgba(0,0,0,.08);
        }
        body{
            margin:0;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
            background:
                    radial-gradient(1200px 600px at 10% -10%, #eef1ff 0%, transparent 60%),
                    radial-gradient(1000px 600px at 110% 0%, #f5f7ff 0%, transparent 60%),
                    #fafbff;
            color:#111;
        }
        .container{ max-width:1100px; margin:40px auto; padding:0 20px; }
        .top{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:18px; }
        .title{ font-weight:650; font-size:20px; letter-spacing:.2px; margin-right:auto; }
        .badge{ padding:6px 10px; border-radius:999px; background:#eef0ff; border:1px solid #e4e6ff; font-size:12px; }

        button{
            padding:10px 14px; border-radius:12px; border:1px solid #e6e6ef;
            background:#fff; box-shadow: var(--shadow); cursor:pointer;
            transition: transform .06s ease, background .15s ease, box-shadow .15s ease;
        }
        button:hover{ background:#f8f9ff; }
        button:active{ transform: translateY(1px) scale(.99); }
        .primary{
            background: linear-gradient(180deg,#6366f1,#4f46e5); color:#fff; border:0;
            box-shadow: 0 8px 22px rgba(79,70,229,.28);
        }

        .card{
            width:fit-content; padding:18px; background:#fff; border:1px solid #ececf4;
            border-radius:22px; box-shadow: var(--shadow);
        }
        .grid{ display:grid; grid-template-columns:repeat(4, var(--tile-size)); gap:var(--gap); }
        .tile{
            height: var(--tile-size); display:flex; align-items:center; justify-content:center;
            border:1px solid #e7e7f0; border-radius: var(--radius);
            font-weight:600; font-size:22px; background:#fff;
            box-shadow: 0 2px 8px rgba(0,0,0,.05); user-select:none;
            transition: transform .08s ease, box-shadow .15s ease, background .15s ease;
            cursor:pointer;
        }
        .tile:hover{ transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
        .tile:active{ transform: translateY(0); }
        .tile.disabled{ pointer-events:none; opacity:.6; }
        .empty{
            background: repeating-linear-gradient(45deg,#f6f7ff 0,#f6f7ff 6px,#f0f1ff 6px,#f0f1ff 12px);
            border-style:dashed; color:transparent; cursor:default; box-shadow:none;
        }
        .info{ margin-top:14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; color:#555; font-size:14px; }
        .dot{ width:6px; height:6px; border-radius:50%; background:#d1d5ff; }

        /* Modal */
        .modal-backdrop{ position:fixed; inset:0; background:rgba(10,12,30,.40); display:none;
            align-items:center; justify-content:center; backdrop-filter: blur(2px); }
        .modal{ width:min(420px,92vw); background:#fff; border-radius:20px; padding:22px;
            box-shadow:0 16px 40px rgba(0,0,0,.25); text-align:center; border:1px solid #ececf4; }
        .modal h2{ margin:6px 0 8px; font-size:22px; }
        .modal p{ margin:0 0 16px; color:#555; }
        .medal{ font-size:42px; line-height:1; margin-bottom:8px; filter: drop-shadow(0 6px 10px rgba(250,204,21,.45)); }
        .show{ display:flex; }
        .lose h2{ color:#b91c1c; } /* red title on loss */
    </style>
</head>
<body>
<div class="container">
    <div class="top">
        <div class="title">15-Puzzle</div>
        <span class="badge" id="gameIdBadge">Game: ‚Äî</span>
        <span class="badge" id="status">Loading‚Ä¶</span>
        <button id="new" class="primary">New Game</button>
    </div>

    <div class="card">
        <div id="board" class="grid"></div>
        <div class="info">
            <span>Moves: <strong id="moves">0</strong> / <strong id="maxMoves">250</strong></span>
            <span class="dot"></span>
            <span>Tip: click a tile next to the empty slot.</span>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="winBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="winTitle">
    <div class="modal" id="modal">
        <div class="medal" id="modalEmoji">üèÜ</div>
        <h2 id="winTitle">Congrats ‚Äî you won!</h2>
        <p id="modalText">Total moves: <strong id="movesFinal">0</strong></p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
            <button class="primary" id="playAgain">Play again</button>
            <button id="closeModal">Close</button>
        </div>
    </div>
</div>

<script>
    const MAX_MOVES = 250;

    let gameId = null;
    let moves = 0;
    let gameOver = false;

    const el = (id)=>document.getElementById(id);
    const boardEl   = el('board');
    const statusEl  = el('status');
    const badgeEl   = el('gameIdBadge');
    const movesEl   = el('moves');
    const maxMovesEl= el('maxMoves');
    const modalWrap = el('winBackdrop');
    const modalBox  = el('modal');
    const movesFinal= el('movesFinal');
    const modalText = el('modalText');
    const modalEmoji= el('modalEmoji');
    const winTitle  = el('winTitle');

    document.getElementById('new').onclick = () => createGame();
    document.getElementById('playAgain').onclick = () => { hideModal(); createGame(); };
    document.getElementById('closeModal').onclick = hideModal;

    async function createGame(){
        gameOver = false;
        moves = 0; movesEl.textContent = moves; maxMovesEl.textContent = MAX_MOVES;
        const r = await fetch('/api/game', {method:'POST'});
        gameId = (await r.text()).replace(/"/g,'');
        badgeEl.textContent = 'Game: ' + gameId.slice(0,8);
        statusEl.textContent = 'Shuffled ‚Äî good luck!';
        const b = await state();
        render(b);
        maybeCheckWin(b);
    }

    async function state(){
        const r = await fetch('/api/game/' + gameId);
        return r.json();
    }

    async function move(tile){
        if (gameOver) return;
        await fetch('/api/game/' + gameId + '/move', {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ tileValue: tile })
        });
        moves++; movesEl.textContent = moves;

        const b = await state();
        render(b);

        const won = await maybeCheckWin(b);
        if (won) return;

        if (moves >= MAX_MOVES) {
            endGame(false);
        } else {
            statusEl.textContent = `Keep going‚Ä¶`;
        }
    }

    function isSolved2D(board){
        const solved = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,0];
        const flat = board.flat();
        if (flat.length !== 16) return false;
        for (let i=0;i<16;i++) if (flat[i] !== solved[i]) return false;
        return true;
    }

    async function maybeCheckWin(board){
        const clientSolved = isSolved2D(board);
        let serverSolved = false;
        try { serverSolved = await (await fetch('/api/game/' + gameId + '/complete')).json(); } catch {}
        const done = clientSolved || serverSolved;
        if (done) { endGame(true); return true; }
        return false;
    }

    function endGame(won){
        gameOver = true;
        if (won){
            statusEl.textContent = 'Solved üéâ';
            winTitle.textContent = 'Congrats ‚Äî you won!';
            modalEmoji.textContent = 'üèÜ';
            modalBox.classList.remove('lose');
            modalText.innerHTML = 'Total moves: <strong id="movesFinal">'+moves+'</strong>';
        } else {
            statusEl.textContent = 'Out of moves.';
            winTitle.textContent = 'You lost';
            modalEmoji.textContent = 'üíÄ';
            modalBox.classList.add('lose');
            modalText.innerHTML = 'You reached the 250-move limit. Try again!';
        }
        showModal();
    }

    function render(board){
        const flat = board.flat();
        boardEl.innerHTML = '';
        flat.forEach(v=>{
            const d = document.createElement('div');
            d.className = 'tile' + (v===0 ? ' empty' : '') + (gameOver ? ' disabled' : '');
            d.textContent = v===0 ? '' : v;
            if (!gameOver && v !== 0) d.onclick = () => move(v);
            boardEl.appendChild(d);
        });
    }

    function showModal(){ modalWrap.classList.add('show'); }
    function hideModal(){ modalWrap.classList.remove('show'); }

    createGame();
</script>
</body>
</html>
